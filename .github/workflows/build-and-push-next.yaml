name: Push Next Artifacts to Azure Registry

on:
  push:
    branches:
      - next

permissions:
  contents: write
  packages: write

env:
  DOMAIN: infra

jobs:
  push-docker-image:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_URL }}
          username: ${{ secrets.ACR_PUSH_USER }}
          password: ${{ secrets.ACR_PUSH_TOKEN }}

      - name: Build and Push Docker image
        id: build_and_push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ secrets.ACR_URL }}/${{ env.DOMAIN }}/${{ github.event.repository.name }}:next-${{ github.sha }}

  push-helm-package:
    runs-on: ubuntu-latest
    # needs: push-docker-image
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Compute chart tag (semver-compatible)
        id: chart_tag
        shell: bash
        run: |
          BASE_VERSION=$(awk -F ': ' '/^version:/ {print $2}' helm/Chart.yaml)
          echo "tag=${BASE_VERSION}-next-"$GITHUB_SHA"" >> "$GITHUB_OUTPUT"

      - name: Push Chart to ACR
        uses: appany/helm-oci-chart-releaser@v0.5.0
        with:
          name: ${{ github.event.repository.name }}
          repository: helm/${{ env.DOMAIN }}
          tag: ${{ steps.chart_tag.outputs.tag }}
          path: ./helm
          registry: ${{ secrets.ACR_URL }}
          registry_username: ${{ secrets.ACR_PUSH_USER }}
          registry_password: ${{ secrets.ACR_PUSH_TOKEN }}
          update_dependencies: 'true' # Defaults to false

  create-new-site-values-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository (for chart version)
        uses: actions/checkout@v5
        with:
          path: jobnik-manager

      - name: Compute chart tag (semver-compatible)
        id: chart_tag
        shell: bash
        run: |
          set -euo pipefail
          BASE_VERSION=$(awk -F ': ' '/^version:/ {print $2}' jobnik-manager/helm/Chart.yaml)
          echo "tag=${BASE_VERSION}-next-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Checkout helm chart repository
        uses: actions/checkout@v5
        with:
          repository: MapColonies/site-values
          token: ${{ secrets.GH_PAT }}
          path: site-values
          ref: master

      - name: Create and push branch in site-values
        working-directory: site-values
        shell: bash
        run: |
          set -euo pipefail
          BRANCH_NAME="${{ github.event.repository.name }}-${{ github.sha }}"
          git fetch origin --prune
          git checkout master

          # Create branch if it doesn't already exist remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "Branch $BRANCH_NAME already exists on remote; checking it out."
            git fetch origin "$BRANCH_NAME":"$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
            git push --set-upstream origin "$BRANCH_NAME"
            echo "Created and pushed branch $BRANCH_NAME"
          fi

      - name: Update chart version in dev environment
        working-directory: site-values
        shell: bash
        env:
          TAG: ${{ steps.chart_tag.outputs.tag }}
        run: |
          set -euo pipefail
          FILE="${DOMAIN}/environments/dev.yaml"
          CHART_NAME="${{ github.event.repository.name }}"
          echo "Updating chartsVersion.${CHART_NAME} to ${TAG} in ${FILE}"

          if [ ! -f "$FILE" ]; then
            echo "File $FILE not found" >&2
            exit 1
          fi

          # Try to update existing key under chartsVersion; if not found, append it under the chartsVersion block
          TMP_FILE="$(mktemp)"
          set +e
          awk -v chart="$CHART_NAME" -v tag="$TAG" '
            BEGIN{found=0; inBlock=0}
            {
              line=$0
              if ($0 ~ /^[[:space:]]*chartsVersion:[[:space:]]*$/) {
                inBlock=1
              } else if (inBlock && $0 !~ /^[[:space:]]+/) {
                inBlock=0
              }

              if (inBlock && $0 ~ "^[[:space:]]*" chart ":") {
                sub(/:.*/, ": " tag, line)
                print line
                found=1
              } else {
                print $0
              }
            }
            END{ if(found==0) exit 10 }
          ' "$FILE" > "$TMP_FILE"
          code=$?
          set -e

          if [ "$code" -eq 10 ]; then
            echo "chartsVersion.${CHART_NAME} not found; adding it under chartsVersion block."
            awk -v chart="$CHART_NAME" -v tag="$TAG" '
              {
                print $0
                if ($0 ~ /^[[:space:]]*chartsVersion:[[:space:]]*$/) {
                  print "  " chart ": " tag
                }
              }
            ' "$FILE" > "$TMP_FILE"
          fi

          mv "$TMP_FILE" "$FILE"

          if git diff --quiet -- "$FILE"; then
            echo "No changes detected in $FILE"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$FILE"
            git commit -m "chore(dev): update ${CHART_NAME} chart version to ${TAG}"
            git push
          fi
